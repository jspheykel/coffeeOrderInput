<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ja-Di Kopi Receipt Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="pos-container">
        <!-- Menu Container -->
        <div class="menu-container">
            <h1>Ja-Di Kopi Receipt Generator</h1>

            <!-- Coffee Item Autocomplete -->
            <label for="coffee_item">Select Coffee:</label>
            <input type="text" id="coffee_item" name="coffee_item" placeholder="Start typing the coffee name..." autocomplete="off" required>
            <div id="autocomplete-list" class="autocomplete-items"></div>

            <!-- Sugar Option -->
            <label for="sugar">Sugar Option:</label>
            <select id="sugar" name="sugar">
                <option value="No Sugar">No Sugar</option>
                <option value="Less Sugar">Less Sugar</option>
                <option value="Normal Sugar">Normal Sugar</option>
                <option value="Extra Sugar">Extra Sugar</option>
            </select>

            <!-- Ice Option -->
            <label for="ice">Ice Option:</label>
            <select id="ice" name="ice">
                <option value="No Ice">No Ice</option>
                <option value="Less Ice">Less Ice</option>
                <option value="Normal Ice">Normal Ice</option>
                <option value="Extra Ice">Extra Ice</option>
            </select>
        </div>

        <!-- Order Summary Section -->
        <div class="order-container">
            <h2>Order Summary</h2>
            <div class="order-summary">
                <div id="selected-item">Selected Coffee: None</div>
                <div id="selected-sugar">Sugar: None</div>
                <div id="selected-ice">Ice: None</div>
            </div>

            <!-- Customer Name Input -->
            <label for="customer_name">Customer Name:</label>
            <input type="text" id="customer_name" name="customer_name" required>

            <!-- Generate Receipt Button -->
            <button type="button" onclick="generateReceipt()">Print Receipt</button>
        </div>
    </div>

    <script>
        const coffeeInput = document.getElementById("coffee_item");
        const autocompleteList = document.getElementById("autocomplete-list");
        let selectedCoffee = '';
        let selectedSugar = 'None';
        let selectedIce = 'None';
        let debounceTimeout = null;

        // Coffee selection autocomplete
        coffeeInput.addEventListener("input", function() {
            const query = this.value.trim();

            // Clear previous results
            autocompleteList.innerHTML = "";

            // Don't proceed if the query is empty
            if (!query) return;

            // Debounce to limit API calls (e.g., wait 300ms after last keystroke)
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                fetchAutocompleteResults(query);
            }, 300);
        });

        function fetchAutocompleteResults(query) {
            fetch(`/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    // If no data, show "no results" or empty the list
                    autocompleteList.innerHTML = "";
                    if (data.length === 0) {
                        autocompleteList.innerHTML = "<div>No results found</div>";
                        return;
                    }

                    // Populate the autocomplete dropdown with results
                    data.forEach(item => {
                        const itemElement = document.createElement("div");
                        itemElement.textContent = item;
                        itemElement.addEventListener("click", function() {
                            // Set the clicked coffee item as the input value
                            coffeeInput.value = item;
                            selectedCoffee = item;
                            document.getElementById('selected-item').innerText = `Selected Coffee: ${item}`;
                            autocompleteList.innerHTML = ""; // Clear suggestions

                            // Check if the selected coffee is "Hot" and disable the ice dropdown
                            if (item.toLowerCase().includes("hot")) {
                                selectedIce = "No Ice";
                                document.getElementById('ice').value = "No Ice";
                                document.getElementById('ice').disabled = true;
                                document.getElementById('selected-ice').innerText = `Ice: No Ice`;
                            } else {
                                // If it's not hot coffee, re-enable the ice dropdown
                                document.getElementById('ice').disabled = false;
                            }
                        });
                        autocompleteList.appendChild(itemElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching autocomplete results:', error);
                });
        }

        // Update selected sugar level in the order summary
        document.getElementById('sugar').addEventListener('change', function() {
            selectedSugar = this.value;
            document.getElementById('selected-sugar').innerText = `Sugar: ${selectedSugar}`;
        });

        // Update selected ice level in the order summary
        document.getElementById('ice').addEventListener('change', function() {
            selectedIce = this.value;
            document.getElementById('selected-ice').innerText = `Ice: ${selectedIce}`;
        });

        // Function to generate receipt
        function generateReceipt() {
            const customerName = document.getElementById('customer_name').value;

            if (selectedCoffee && customerName) {
                alert(`Receipt Generated\n\nCustomer: ${customerName}\nCoffee: ${selectedCoffee}\nSugar: ${selectedSugar}\nIce: ${selectedIce}`);
            } else {
                alert('Please select a coffee and enter a customer name.');
            }
        }
    </script>    
</body>
</html>
